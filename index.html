<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Horarios Club Deportivo — LL. RR. 2025-2026</title>
  <style>
    :root{--bg:#0b0b0c;--panel:#131317;--muted:#8f95a3;--edge:#24262e;--brand:#e91b2c}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b0b0c,#151518 42%,#101013);color:#e7e9ee}
    .wrap{max-width:1100px;margin:auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;gap:12px;align-items:center}
    .badge{background:var(--brand);color:#fff;font-weight:700;padding:6px 10px;border-radius:999px;letter-spacing:.3px}
    h1{font-size:clamp(20px,2.2vw,28px);margin:0;line-height:1.2}
    .sub{color:var(--muted);font-size:.95rem}
    .panel{background:var(--panel);border:1px solid var(--edge);border-radius:16px;padding:14px}
    .filters{display:grid;grid-template-columns:1fr;gap:12px}
    label{display:block;font-size:.8rem;color:var(--muted);margin:6px 2px}
    input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--edge);background:#0f1014;color:#e7e9ee}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .chip{border:1px solid var(--edge);padding:6px 10px;border-radius:999px;font-size:.85rem;color:#d6dae3;background:#0e0f12;cursor:pointer}
    .chip.active{background:var(--brand);border-color:transparent;color:white}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px;margin-top:16px}
    @media (max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
    .card{background:#0e0f13;border:1px solid var(--edge);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:8px}
    .card h3{margin:0;font-size:1.05rem}
    .meta{display:flex;gap:8px;flex-wrap:wrap;color:#c9ced8;font-size:.9rem}
    .pill{background:#10121a;border:1px solid var(--edge);border-radius:999px;padding:4px 8px}
    .list{display:flex;flex-wrap:wrap;gap:8px}
    .tag{background:var(--brand);border:1px solid var(--brand);border-radius:10px;padding:5px 8px;font-size:.85rem;color:#fff;cursor:pointer}
    .empty{opacity:.75;text-align:center;padding:28px}
    .hint{color:#b5bac7;font-size:.9rem;margin-top:4px}
    .footer{margin:24px 4px;color:#9aa2b3}
    .btn{appearance:none;border:1px solid var(--edge);background:#0f1116;color:#e7e9ee;border-radius:12px;padding:10px 12px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="badge">LL. RR. · 2025 - 2026</div>
        <div>
          <h1>Horarios · Club Deportivo</h1>
          <div class="sub">Usa la <strong>búsqueda</strong> o los <strong>chips</strong> de disciplina, grado/año y día.</div>
        </div>
      </div>
      <button class="btn" id="reset">Reiniciar filtros</button>
    </header>

    <section class="panel">
      <div class="filters">
        <div>
          <label for="text">Búsqueda rápida</label>
          <input id="text" placeholder="Escribe: ajedrez, 3er, futsal…"/>
        </div>
      </div>
      <div class="chips" id="quick"></div>
      <div class="chips" id="quickGrades"></div>
      <div class="chips" id="quickDays"></div>
    </section>

    <section id="results" class="grid" aria-live="polite"></section>
    <div id="empty" class="empty" hidden>Sin coincidencias con los filtros actuales.</div>

    <div class="footer">
      <div class="hint">Sugerencia: haz clic en una disciplina, un grado o un día para filtrar al instante.</div>
    </div>
  </div>

<script>
/* ===== Utiles ===== */
const normal = s => s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9 ]/g,' ').replace(/\s+/g,' ').trim();
const DAY_ORDER = ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"];
const GRADE_ORDER = ["1er Grado","2do Grado","3er Grado","4to Grado","5to Grado","6to Grado","1er Año","2do Año","3er Año","4to Año","5to Año"];
function getTodayName(){ const dias=["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"]; return dias[new Date().getDay()]; }

/* ===== Carga dinámica desde Google Sheets (sin cambiar diseño) ===== */
const SHEET_ID = "13YowVOIm6LWjbFuK1FiY9zyXbXzkKXZLmgcta-TDnkg";
const SHEET_NAME = "HorariosDelClubDeportivo2025";
let DATA = []; // se pobla desde Sheets

function parseCSV(text){
  const rows=[]; let cur=[], cell="", inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(inQ){
      if(c=='"' && n=='"'){ cell+='"'; i++; continue; }
      if(c=='"'){ inQ=false; continue; }
      cell+=c;
    } else {
      if(c=='"'){ inQ=true; continue; }
      if(c==','){ cur.push(cell); cell=""; continue; }
      if(c=='\n'){ cur.push(cell); rows.push(cur); cur=[]; cell=""; continue; }
      if(c=='\r'){ continue; }
      cell+=c;
    }
  }
  if(cell.length || cur.length){ cur.push(cell); rows.push(cur); }
  return rows;
}
const normalizeHeader = h => h.toLowerCase().trim();

async function loadFromSheet(){
  const urls = [
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`,
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`,
  ];
  for(const url of urls){
    try{
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      if(/<\/*html/i.test(text)) throw new Error('No CSV (revisa permisos públicos)');
      const rows = parseCSV(text);
      const header = rows.shift().map(normalizeHeader);
      const idx = n => header.indexOf(n);
      const di=idx('day'), gi=idx('grade'), ci=idx('discipline'), hi=idx('time'), ti=idx('type');
      if(di<0||gi<0||ci<0) throw new Error('Faltan columnas: day, grade, discipline');

      DATA = rows
        .filter(r=>r && r.length)
        .map(r=>({
          day:(r[di]||'').trim(),
          grade:(r[gi]||'').trim(),
          disciplines: ((r[ci]||'').includes('|') ? (r[ci]||'').split('|') : (r[ci]||'').split(';'))
                        .map(s=>s.trim()).filter(Boolean),
          time:(r[hi]||'').trim(),
          type:(r[ti]||'Deportes').trim()
        }))
        .filter(x=>x.day && x.grade && x.disciplines.length);

      render();
      console.log('Datos cargados desde Google Sheets:', DATA.length);
      return;
    }catch(err){ console.warn('Intento fallido con', url, err); }
  }
  alert('No se pudo cargar la hoja. Verifica “Cualquier persona con el vínculo (lector)” y el nombre de la pestaña.');
}

/* ===== Estado (chips) ===== */
let selectedDay = '';
let selectedGrade = '';
let selectedDisc = '';

/* ===== Elementos ===== */
const $ = s => document.querySelector(s);
const results = $('#results');
const empty = $('#empty');
const text = $('#text');
const quick = $('#quick');
const quickGrades = $('#quickGrades');
const quickDays = $('#quickDays');

/* ===== Chips ===== */
const HOT = ["Ajedrez","Astronomía","Atletismo","Baloncesto","Béisbol","Futsal","Fútbol campo","Música","Roblegaita","Robótica","Tenis"];
quick.innerHTML = HOT.map(name=>`<button class="chip" data-disc="${name}">${name}</button>`).join('');
quick.addEventListener('click', e=>{
  const b = e.target.closest('.chip'); if(!b) return;
  const willActivate = !(b.classList.contains('active'));
  document.querySelectorAll('#quick .chip').forEach(c=>c.classList.remove('active'));
  selectedDisc = willActivate ? b.dataset.disc : '';
  if(willActivate) b.classList.add('active');
  render();
});

// Grados (incluye "Todos")
quickGrades.innerHTML = ['Todos',...GRADE_ORDER].map(g=>`<button class="chip" data-grade="${g}">${g}</button>`).join('');
quickGrades.addEventListener('click', e=>{
  const b = e.target.closest('.chip'); if(!b) return;
  const val = b.dataset.grade;
  const willActivate = !(b.classList.contains('active'));
  document.querySelectorAll('#quickGrades .chip').forEach(c=>c.classList.remove('active'));
  selectedGrade = (val==='Todos'||!willActivate) ? '' : val;
  if(willActivate) b.classList.add('active');
  render();
});

// Días (incluye "Todos" y "Hoy")
const todayName = getTodayName();
const DAYS = ['Todos','Hoy',...DAY_ORDER];
quickDays.innerHTML = DAYS.map(d=>`<button class="chip" data-day="${d}">${d}</button>`).join('');
quickDays.addEventListener('click', e=>{
  const b = e.target.closest('.chip'); if(!b) return;
  const val = b.dataset.day;
  const willActivate = !(b.classList.contains('active'));
  document.querySelectorAll('#quickDays .chip').forEach(c=>c.classList.remove('active'));
  if(val==='Hoy' && willActivate){
    selectedDay = DAY_ORDER.includes(todayName) ? todayName : '';
    b.classList.add('active');
  } else {
    selectedDay = (val==='Todos'||!willActivate) ? '' : val;
    if(willActivate) b.classList.add('active');
  }
  render();
});

// Búsqueda rápida
text.addEventListener('input', render);

// Reinicio
$('#reset').addEventListener('click',()=>{
  selectedDay = selectedGrade = selectedDisc = '';
  text.value = '';
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  const gAll = document.querySelector('#quickGrades .chip[data-grade="Todos"]'); if(gAll) gAll.classList.add('active');
  const dAll = document.querySelector('#quickDays .chip[data-day="Todos"]'); if(dAll) dAll.classList.add('active');
  render();
});

/* ===== Render (agrupado por grado) ===== */
function render(){
  const qDay=selectedDay, qGrade=selectedGrade, qDisc=selectedDisc, qText=normal(text.value);

  const filtered = DATA.filter(row=>{
    const okDay   = !qDay   || row.day===qDay;
    const okGrade = !qGrade || row.grade===qGrade;
    const okDisc  = !qDisc  || row.disciplines.includes(qDisc);
    const searchable = normal(`${row.day} ${row.grade} ${row.type||''} ${row.disciplines.join(' ')}`);
    const okText = !qText || searchable.includes(qText);
    return okDay && okGrade && okDisc && okText;
  });

  // Agrupar por grado -> por día -> set de disciplinas
  const groups = new Map();
  for(const row of filtered){
    if(!groups.has(row.grade)) groups.set(row.grade, new Map());
    const byDay = groups.get(row.grade);
    if(!byDay.has(row.day)) byDay.set(row.day, new Set());
    row.disciplines.forEach(d=>byDay.get(row.day).add(d));
  }

  // Render
  results.innerHTML='';
  const gradesSorted = Array.from(groups.keys()).sort((a,b)=>GRADE_ORDER.indexOf(a)-GRADE_ORDER.indexOf(b));
  gradesSorted.forEach(grade=>{
    const byDay = groups.get(grade);
    const daysSorted = Array.from(byDay.keys()).sort((a,b)=>DAY_ORDER.indexOf(a)-DAY_ORDER.indexOf(b));
    const card=document.createElement('article');
    card.className='card';
    const dayBlocks = daysSorted.map(day=>{
      const disc = Array.from(byDay.get(day)).sort((a,b)=>a.localeCompare(b,'es',{numeric:true}));
      return `<div class="meta"><span class="pill">${day}</span></div>
              <div class="list">${disc.map(d=>`<button class="tag" data-d="${d}">${d}</button>`).join('')}</div>`;
    }).join('');
    card.innerHTML = `<h3>${grade}</h3>${dayBlocks}`;
    card.addEventListener('click',e=>{
      const t=e.target.closest('[data-d]'); if(!t) return;
      selectedDisc=t.dataset.d;
      document.querySelectorAll('#quick .chip').forEach(c=>c.classList.toggle('active', c.dataset.disc===t.dataset.d));
      render();
    });
    results.appendChild(card);
  });
  empty.hidden = (gradesSorted.length!==0);
}

/* ===== Inicio ===== */
(function init(){
  const gAll = document.querySelector('#quickGrades .chip[data-grade="Todos"]');
  const dAll = document.querySelector('#quickDays .chip[data-day="Todos"]');
  if(gAll) gAll.classList.add('active');
  const tn = getTodayName();
  if(DAY_ORDER.includes(tn)){
    const todayBtn = document.querySelector('#quickDays .chip[data-day="Hoy"]');
    if(todayBtn){ todayBtn.classList.add('active'); selectedDay = tn; }
  } else if(dAll){ dAll.classList.add('active'); }
  render();
  loadFromSheet(); // << carga la hoja
})();
</script>
</body>
</html>
